/*
----------------------------------------------------------------------------------------
    GeneLab Data Processing Proteomics Workflow Nextflow config file
----------------------------------------------------------------------------------------
    Default config options for all compute environments
----------------------------------------------------------------------------------------
*/

// Plugins
plugins {
  id 'nf-schema@2.6.1'
}

// Global default params, used in configs
params {
    // Input options
    accession                   = null // Accession number (OSD-# or GLDS-#)
    runsheet                    = null // For OSDR datasets, runsheet will be generated based on the ISA.zip associated with the dataset
    isa_archive                 = null // If a runsheet is not supplied, ISA.zip will be pulled from OSDR unless this is supplied    
    manifest                    = null // FragPipe manifest file. If not provided, will be generated from runsheet
    fragpipe_tools              = "${projectDir}/conf/tools"
    fragpipe_workflow           = null // Preset workflow name: "LFQ-MBR", "TMT10", "TMT16", or "TMT16-phospho". Used to select workflow file if fragpipe_workflow_config is not provided. Should be set even when using fragpipe_workflow_config for proper workflow-specific functionality (e.g., MSstats runs only for LFQ-MBR).
    fragpipe_workflow_config    = null // FragPipe workflow config file path. If provided, takes precedence over fragpipe_workflow parameter for workflow file selection. Note: fragpipe_workflow should still be set to enable workflow-specific features.

    // Database options - use EITHER uniprot_id OR reference_proteome, not both
    uniprot_id                  = null // UniProt proteome ID (e.g., UP000059680, UP001231189). If provided, will download proteome FASTA from UniProt using Philosopher. Cannot be used with reference_proteome.
    reference_proteome          = null // Pre-formed FASTA file path. If provided, will use this file via --custom. Cannot be used with uniprot_id.
    
    // Philosopher proteome database options
        // For `uniprot_id` UniProt pull only
    philosopher_reviewed           = true  // Download only reviewed (Swiss-Prot) entries. Only valid with --id, ignored with --custom
    philosopher_isoforms           = true  // Include protein isoforms in database. Only valid with --id, ignored with --custom
    philosopher_enzyme             = 'trypsin' // Enzyme for digestion: trypsin, lys_c, lys_n, glu_c, chymotrypsin
    philosopher_spike_in           = null  // Path to spike-in FASTA file to add to database (e.g., iRT peptides for retention time calibration)
        // For both `uniprot_id` UniProt pull and `reference_proteome` input proteome fasta
    philosopher_contaminants       = true  // Add common contaminant proteins (human keratins, trypsin, etc.). For runs using `reference_proteome` , contaminant presence is checked before adding. 
    philosopher_contaminants_prefix = null // Mark contaminant sequences with this prefix tag when pulling from UniProt. Requires philosopher_contaminants=true. Used for UniProt Proteome pull runs only; not used for runs using `reference_proteome`
    philosopher_decoy_prefix       = 'rev_' // Prefix for decoy sequences (reversed proteins)
    philosopher_decoys             = true   // Add decoy sequences to database. For runs using `reference_proteome` , decoy presence is checked with grep `philosopher_decoy_prefix` before adding.
    
    // pmultiqc
    multiqc_config              = "${projectDir}/conf/multiqc.config"

    // FragPipe-Analyst R parameters (order: input/LFQ → filtering → DE → feature plots → QC → enrichment)
    fp_analyst_lfq_type             = 'MaxLFQ' // LFQ column type: Intensity or MaxLFQ (for LFQ mode only)
    fp_analyst_min_global_appearance     = 0   // At least X% non-missing across all samples (0-100). 0 = no filter.
    fp_analyst_min_appearance_one_cond   = 0   // At least X% non-missing in at least one condition (0-100). 0 = no filter. Ubiquitin LFQ: 10-33% -> 2777 "reproducibly quantified".
    fp_analyst_de_alpha             = 0.05  // Adjusted p-value threshold for DE significance
    fp_analyst_de_lfc               = 1.0   // Log2 fold change threshold for DE significance
    fp_analyst_de_fdr               = 'Benjamini Hochberg'  // Type of FDR correction: 'Benjamini Hochberg' or 'Local and tail area-based'
    fp_analyst_protein_feature_list = null // Comma-separated protein IDs for feature plots (by rownames). If empty, use top_n_protein.
    fp_analyst_gene_feature_list   = null // Comma-separated gene names for feature plots (by Gene column). If empty, use top_n_gene. Note: peptide mode uses Index (ProteinID_Sequence); gene feature plots not currently functional
    fp_analyst_top_n_protein       = 10   // When feature_list_protein empty: plot top N variable by protein ID. 0 = skip.
    fp_analyst_top_n_gene          = 10   // When feature_list_gene empty: plot top N variable by gene. 0 = skip.
    fp_analyst_qc_show_imputed      = true // Use imputed data for QC plots when qc_include_both=false. false = use unimputed.
    fp_analyst_qc_include_both      = false // true = generate both imputed and unimputed versions of QC plots (PCA, correlation, CVs, feature).
    fp_analyst_volcano_display_names = true  // Volcano: display names on significant points. Matches GUI 'Display names' (true/false).
    fp_analyst_volcano_show_gene    = true  // Volcano: show gene names (true) or protein/peptide ID (false). Matches GUI 'Show gene names'. Note: peptide mode uses Index (ProteinID_Sequence) so gene names are not applicable; set false for peptide level.
    fp_analyst_volcano_highlight_feature = ''  // Comma-delimited features to highlight (e.g. TP53, BRCA1). Matches GUI 'select features to highlight'.
    fp_analyst_pathway_database     = 'Hallmark' // Pathway enrichment: Hallmark, KEGG, Reactome. '' = skip.
    fp_analyst_pathway_direction    = 'Both'    // Pathway direction: Up, Down, Both
    fp_analyst_go_database          = 'GO Biological Process'  // Gene Ontology enrichment: GO Biological Process, GO Cellular Component, GO Molecular Function. '' = skip.
    fp_analyst_go_direction         = 'Both'    // GO direction: Up, Down, Both

    dp_tools_plugin             = null      // Path to dp_tools plugin
    api_url                     = "https://visualization.osdr.nasa.gov/biodata/api/v2/dataset/*/"
    assay_suffix                = '_GLProteomics' // Suffix to append to output filenames

    // Boilerplate options
    output_dir                  = '.' // Used to set the location where the results directory will be created
    results_dir                 = null // Used to name the directory that will hold the main workflow outputs. Leave as null
    publish_dir_mode            = 'link' // Published outputs may be symlinks if using containerized environments
    email                       = null
    version                     = false

}
validation {
    help {
        enabled = true
    }
    lenientMode = true
}

// Profiles:
// The following profile definitions are used to set environments for the pipeline.
//  Configs can be used to set executor configs, container profiles, tag and process-specific resource allocations, retry strategies, etc.

// The default executor profile is slurm which is defined under the profile 'slurm'. There is no default container-based profile.
//  To run processes locally, you must set the profile to local with 'nextflow run main.nf ... --profile local'

// By default, the container profile is not set meaning that the local environment is used.
//  The container profile is set using 'nextflow run main.nf ... --profile <profile_name>' 

// Multiple profiles can be set in the nextflow run command, e.g. 'nextflow run main.nf ... --profile <executor_profile>,<container_profile>'

// See https://www.nextflow.io/docs/latest/config.html#config-profiles for more information


profiles {
    debug {
        dumpHashes              = true
        process.beforeScript    = 'echo $HOSTNAME'
        cleanup                 = false
    }
    docker {
        docker.enabled          = true
        conda.enabled           = true
        singularity.enabled     = false
        podman.enabled          = false
        shifter.enabled         = false
        charliecloud.enabled    = false
        apptainer.enabled       = false
        docker.runOptions       = '-u $(id -u):$(id -g)'
        includeConfig 'conf/by_docker_image.config'
    }
    singularity {
        singularity.enabled     = true
        singularity.autoMounts  = true
        conda.enabled           = false
        docker.enabled          = false
        podman.enabled          = false
        shifter.enabled         = false
        charliecloud.enabled    = false
        apptainer.enabled       = false
        // Address issue: https://github.com/nextflow-io/nextflow/issues/1210
        process {
          containerOptions = "--no-home"
          errorStrategy = { 
            task.exitStatus == 255 ? 'retry' : 'terminate' 
            }
        }
        includeConfig 'conf/by_docker_image.config'
    }
    gitpod {
        executor.name           = 'local'
        executor.cpus           = 4
        executor.memory         = 8.GB
    }
    slurm {
        process {
            executor = 'slurm' // run using slurm backend (unless a process specifies otherwise), Nextflow will generate the sbatch script and submit for you
            errorStrategy = { task.exitStatus in ((130..145) + 104) ? 'retry' : 'finish' }
            maxRetries    = 1
            maxErrors     = '-1'
            cache = 'lenient'
        }
    }
    local {
        process {
            executor = 'local'
            errorStrategy = { task.exitStatus in ((130..145) + 104) ? 'retry' : 'finish' }
            maxRetries    = 1
            maxErrors     = '-1'
        }
    }
}

// Process-specific resource allocations
process {
    withName: 'GENERATE_MANIFEST' {
        cpus = 1
        memory = 2.GB
    }
    
    withName: 'STAGE_INPUT' {
        cpus = 1
        memory = 2.GB
    }
    
    withName: 'RUNSHEET_TO_MANIFEST' {
        cpus = 1
        memory = 2.GB
    }    

    withName: 'WORKFLOW_CONFIG_TO_JSON' {
        cpus = 1
        memory = 2.GB
    }    
    withName: 'GET_PROTEOME' {
        cpus = 1
        memory = 2.GB
    }
    
    withName: 'CHECK_DECOYS_CONTAMS' {
        cpus = 1
        memory = 2.GB
    }
    
    withName: 'UPDATE_WORKFLOW_CONFIG' {
        cpus = 1
        memory = 2.GB
    }
    
    withName: 'RAWBEANS_QC' {
        cpus = 1
        memory = 2.GB
    }
    
    withName: 'RAWBEANS_QC_ALL' {
        cpus = 1
        memory = 2.GB
    }
    
    withName: 'RAW_READS_PMULTIQC' {
        cpus = 1
        memory = 4.GB
    }
    
    withName: 'FRAGPIPE' {
        cpus = 16
        memory = 48.GB
        stageInMode = 'copy'
    }
}

// Set default registry for Docker and Singularity

// Adapted from : https://github.com/nf-core/rnaseq/blob/master/nextflow.config
def trace_timestamp = new java.util.Date().format( 'yyyy-MM-dd_HH-mm-ss')
timeline {
    enabled = true
    file    = "${params.output_dir}/nextflow_info/execution_timeline_${trace_timestamp}.html"
}
report {
    enabled = true
    file    = "${params.output_dir}/nextflow_info/execution_report_${trace_timestamp}.html"
}
trace {
    enabled = true
    file    = "${params.output_dir}/nextflow_info/execution_trace_${trace_timestamp}.txt"
}
dag {
    enabled = true
    file    = "${params.output_dir}/nextflow_info/pipeline_dag_${trace_timestamp}.html"
}

manifest {
    name            = 'NASA GeneLab Data Processing Proteomics Pipeline'
    homePage        = 'https://github.com/nasa/GeneLab_Data_Processing/tree/master/Proteomics'
    description     = 'Nextflow workflow for Documents GL-DPPD-7101-G and GL-DPPD-7115.'
    mainScript      = 'main.nf'
    nextflowVersion = '!>=24.10.6'
    version         = '1.0.0'
}
